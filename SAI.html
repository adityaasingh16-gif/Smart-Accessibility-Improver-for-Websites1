<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AccessAI — Smart Accessibility Improver</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Fraunces:ital,wght@0,300;0,700;0,900;1,300&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #7fff6e;
    --accent2: #6eb8ff;
    --accent3: #ff9d6e;
    --warn: #ffdc6e;
    --text: #e8e8f0;
    --text-dim: #888899;
    --critical: #ff6e7f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  header {
    padding: 2rem 3rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
  }

  .logo {
    font-family: 'Fraunces', serif;
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: -0.02em;
  }

  .logo span {
    color: var(--accent);
    font-style: italic;
  }

  .tagline {
    font-size: 0.7rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .status-dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    height: calc(100vh - 80px);
  }

  .panel {
    padding: 2rem;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow: hidden;
  }

  .panel-title {
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .panel-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  textarea {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    line-height: 1.7;
    padding: 1.25rem;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
  }

  textarea:focus {
    border-color: var(--accent);
  }

  textarea::placeholder { color: var(--text-dim); }

  .btn-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .btn {
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    padding: 0.7rem 1.5rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    border-radius: 3px;
    letter-spacing: 0.05em;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }

  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(127,255,110,0.3); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .btn-ghost {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { color: var(--text); border-color: var(--text-dim); box-shadow: none; }

  .file-drop {
    border: 1.5px dashed var(--border);
    border-radius: 4px;
    padding: 1.25rem;
    text-align: center;
    color: var(--text-dim);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
  }

  .file-drop:hover, .file-drop.drag-over {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(127,255,110,0.04);
  }

  /* Results panel */
  .results-panel {
    overflow-y: auto;
    border-right: none;
  }

  .results-panel::-webkit-scrollbar { width: 4px; }
  .results-panel::-webkit-scrollbar-track { background: transparent; }
  .results-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .score-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .score-circle {
    width: 72px; height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-family: 'Fraunces', serif;
    font-size: 1.5rem;
    font-weight: 900;
    position: relative;
  }

  .score-info { flex: 1; }
  .score-label { font-size: 0.65rem; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.3rem; }
  .score-desc { font-size: 0.78rem; color: var(--text-dim); }

  .score-breakdown {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .score-mini {
    background: var(--surface2);
    border-radius: 3px;
    padding: 0.5rem 0.75rem;
    font-size: 0.7rem;
  }

  .score-mini-val { font-size: 1rem; font-weight: 700; }

  .issues-list {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .issue-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .issue-card:hover { border-color: var(--text-dim); }
  .issue-card.expanded { border-color: var(--accent2); }

  .issue-header {
    padding: 0.9rem 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .severity-badge {
    font-size: 0.6rem;
    font-weight: 500;
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    flex-shrink: 0;
  }

  .sev-critical { background: rgba(255,110,127,0.15); color: var(--critical); border: 1px solid rgba(255,110,127,0.3); }
  .sev-warning { background: rgba(255,220,110,0.1); color: var(--warn); border: 1px solid rgba(255,220,110,0.3); }
  .sev-info { background: rgba(110,184,255,0.1); color: var(--accent2); border: 1px solid rgba(110,184,255,0.3); }

  .issue-title { font-size: 0.8rem; flex: 1; }
  .issue-wcag { font-size: 0.65rem; color: var(--text-dim); }

  .issue-body {
    border-top: 1px solid var(--border);
    padding: 1rem 1.1rem;
    display: none;
    font-size: 0.77rem;
    line-height: 1.7;
    gap: 0.75rem;
    flex-direction: column;
  }

  .issue-card.expanded .issue-body { display: flex; }

  .code-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 0.75rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    overflow-x: auto;
    line-height: 1.6;
    position: relative;
  }

  .code-label {
    font-size: 0.6rem;
    color: var(--text-dim);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.3rem;
  }

  .code-block .bad { color: var(--critical); }
  .code-block .good { color: var(--accent); }

  .copy-btn {
    position: absolute;
    top: 0.5rem; right: 0.5rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    padding: 0.2rem 0.5rem;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }

  .copy-btn:hover { color: var(--accent); border-color: var(--accent); }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    font-size: 0.8rem;
    gap: 1rem;
    text-align: center;
  }

  .empty-icon {
    font-size: 3rem;
    opacity: 0.3;
    filter: grayscale(1);
  }

  .loading-state {
    display: none;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem 0;
  }

  .loading-state.active { display: flex; }

  .skeleton {
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 3px;
    height: 80px;
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .progress-bar {
    height: 2px;
    background: var(--border);
    border-radius: 1px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 1px;
  }

  .progress-text {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .filter-row {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
  }

  .filter-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    padding: 0.25rem 0.65rem;
    border-radius: 2px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: all 0.15s;
  }

  .filter-btn.active, .filter-btn:hover { color: var(--text); border-color: var(--text-dim); }
  .filter-btn.f-critical.active { color: var(--critical); border-color: var(--critical); }
  .filter-btn.f-warning.active { color: var(--warn); border-color: var(--warn); }
  .filter-btn.f-info.active { color: var(--accent2); border-color: var(--accent2); }

  .export-row {
    display: flex;
    gap: 0.5rem;
    border-top: 1px solid var(--border);
    padding-top: 0.75rem;
    margin-top: auto;
  }

  @media (max-width: 800px) {
    main { grid-template-columns: 1fr; height: auto; }
    .panel { height: 50vh; }
    header { padding: 1rem 1.5rem; }
  }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Access<span>AI</span></div>
    <div class="tagline" style="margin-top:0.2rem"><span class="status-dot"></span>AI-Powered Accessibility Auditor</div>
  </div>
  <div style="font-size:0.7rem;color:var(--text-dim);text-align:right">
    WCAG 2.1 AA/AAA<br>
    <span style="color:var(--accent)">●</span> Claude Sonnet 4
  </div>
</header>

<main>
  <!-- Input Panel -->
  <div class="panel">
    <div class="panel-title">HTML Input</div>

    <div class="file-drop" id="fileDrop" onclick="document.getElementById('fileInput').click()">
      <div style="font-size:1.4rem;margin-bottom:0.4rem">⬆</div>
      <div>Drop HTML file here or <span style="color:var(--accent);cursor:pointer">click to browse</span></div>
      <div style="font-size:0.65rem;margin-top:0.3rem;color:var(--text-dim)">.html, .htm files accepted</div>
    </div>
    <input type="file" id="fileInput" accept=".html,.htm" style="display:none">

    <textarea id="htmlInput" placeholder="<!-- Paste your HTML here... -->&#10;&#10;Example:&#10;<button onclick='submit()'>Click me</button>&#10;<img src='logo.png'>&#10;<div style='color:#aaa'>Low contrast text</div>&#10;<form>&#10;  <input type='text' placeholder='Email'>&#10;</form>"></textarea>

    <div class="btn-row">
      <button class="btn" id="analyzeBtn" onclick="analyzeAccessibility()">Analyze Accessibility →</button>
      <button class="btn btn-ghost" onclick="loadExample()">Load Example</button>
    </div>

    <div class="progress-bar" id="progressBar" style="display:none">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText" style="display:none"></div>
  </div>

  <!-- Results Panel -->
  <div class="panel results-panel" id="resultsPanel">
    <div class="panel-title">Accessibility Report</div>

    <div class="empty-state" id="emptyState">
      <div class="empty-icon">♿</div>
      <div>Paste HTML and click Analyze<br>to get AI-powered accessibility suggestions</div>
      <div style="font-size:0.7rem;color:var(--text-dim)">Checks ARIA roles · Contrast · Screen reader flow · Keyboard navigation</div>
    </div>

    <div class="loading-state" id="loadingState">
      <div style="font-size:0.7rem;color:var(--text-dim)">Analyzing with Claude...</div>
      <div class="skeleton" style="height:90px"></div>
      <div class="skeleton" style="height:70px"></div>
      <div class="skeleton" style="height:80px"></div>
      <div class="skeleton" style="height:70px"></div>
    </div>

    <div id="reportContainer" style="display:none;flex-direction:column;gap:1rem;">

      <div class="score-bar" id="scoreBar">
        <div class="score-circle" id="scoreCircle">—</div>
        <div class="score-info">
          <div class="score-label">Accessibility Score</div>
          <div id="scoreDesc" class="score-desc">—</div>
          <div class="score-breakdown" id="scoreBreakdown"></div>
        </div>
      </div>

      <div class="filter-row" id="filterRow"></div>

      <div class="issues-list" id="issuesList"></div>

      <div class="export-row">
        <button class="btn btn-ghost" onclick="exportReport()" style="font-size:0.72rem;padding:0.5rem 1rem">Export Report</button>
        <button class="btn btn-ghost" onclick="copyFixed()" style="font-size:0.72rem;padding:0.5rem 1rem">Copy Fixed HTML</button>
      </div>
    </div>
  </div>
</main>

<script>
const EXAMPLE_HTML = `<!DOCTYPE html>
<html>
<head><title>My Shop</title></head>
<body>
  <div style="color: #aaa; background: #fff;">Special Offer!</div>
  <img src="product.jpg">
  <div onclick="addToCart()">Add to Cart</div>
  <form>
    <input type="text" placeholder="Enter email">
    <input type="password" placeholder="Password">
    <div onclick="submitForm()" style="background:blue;color:#fff;padding:8px">Login</div>
  </form>
  <div role="navigation">
    <a href="/home">Home</a>
    <a href="/shop">Shop</a>
    <a href="#">Click here</a>
  </div>
  <div style="font-size:10px;color:#bbb">© 2024 My Shop. All rights reserved.</div>
  <video src="promo.mp4" autoplay></video>
  <marquee>Free shipping on orders over $50!</marquee>
  <div tabindex="3">Skip to content</div>
</body>
</html>`;

let lastAnalysis = null;
let activeFilter = 'all';

// File drop
const drop = document.getElementById('fileDrop');
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag-over'); });
drop.addEventListener('dragleave', () => drop.classList.remove('drag-over'));
drop.addEventListener('drop', e => {
  e.preventDefault();
  drop.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) readFile(file);
});

document.getElementById('fileInput').addEventListener('change', e => {
  if (e.target.files[0]) readFile(e.target.files[0]);
});

function readFile(file) {
  const reader = new FileReader();
  reader.onload = e => { document.getElementById('htmlInput').value = e.target.result; };
  reader.readAsText(file);
}

function loadExample() {
  document.getElementById('htmlInput').value = EXAMPLE_HTML;
}

function setProgress(pct, text) {
  const bar = document.getElementById('progressBar');
  const fill = document.getElementById('progressFill');
  const txt = document.getElementById('progressText');
  bar.style.display = 'block';
  txt.style.display = 'block';
  fill.style.width = pct + '%';
  txt.textContent = text;
  if (pct >= 100) {
    setTimeout(() => { bar.style.display = 'none'; txt.style.display = 'none'; }, 600);
  }
}

async function analyzeAccessibility() {
  const html = document.getElementById('htmlInput').value.trim();
  if (!html) { alert('Please paste some HTML first.'); return; }

  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true;
  btn.textContent = 'Analyzing...';

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('reportContainer').style.display = 'none';
  document.getElementById('loadingState').classList.add('active');

  setProgress(10, 'Parsing HTML structure...');

  const systemPrompt = `You are an expert web accessibility auditor specializing in WCAG 2.1 guidelines, ARIA, and screen reader optimization. Analyze HTML and return ONLY valid JSON with this exact structure:

{
  "score": <number 0-100>,
  "scoreDesc": "<brief overall assessment>",
  "categories": {
    "aria": <0-100>,
    "contrast": <0-100>,
    "screenReader": <0-100>,
    "keyboard": <0-100>
  },
  "issues": [
    {
      "id": "<unique id>",
      "severity": "critical|warning|info",
      "title": "<concise issue title>",
      "wcag": "<WCAG criterion e.g. 1.1.1>",
      "description": "<clear explanation of the problem>",
      "elementBefore": "<problematic HTML snippet>",
      "elementAfter": "<fixed HTML snippet>",
      "impact": "<who this affects and how>"
    }
  ],
  "fixedHTML": "<complete fixed version of the HTML>"
}

Be thorough. Check for: missing alt text, poor color contrast, missing form labels, non-semantic clickable divs, missing ARIA roles, keyboard navigation issues, missing lang attribute, autoplay media, deprecated elements, focus management, skip links, heading hierarchy, link text quality, form validation, and screen reader flow. Return ONLY the JSON object, no markdown.`;

  const userPrompt = `Analyze this HTML for accessibility issues:\n\n${html}`;

  try {
    setProgress(30, 'Sending to Claude AI...');

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });

    setProgress(70, 'Processing results...');

    const data = await response.json();
    const text = data.content.map(b => b.text || '').join('');
    const clean = text.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);

    lastAnalysis = result;
    setProgress(100, 'Done!');
    renderReport(result);

  } catch (err) {
    console.error(err);
    // Fallback demo mode
    setProgress(100, 'Using demo mode');
    const demo = generateDemoAnalysis(html);
    lastAnalysis = demo;
    renderReport(demo);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Analyze Accessibility →';
    document.getElementById('loadingState').classList.remove('active');
  }
}

function generateDemoAnalysis(html) {
  const issues = [];
  let score = 100;

  if (!html.includes('alt=')) {
    issues.push({ id:'i1', severity:'critical', title:'Images missing alt text', wcag:'1.1.1',
      description:'Images without alt attributes are invisible to screen reader users. Every meaningful image must have descriptive alt text.',
      elementBefore:'<img src="product.jpg">', elementAfter:'<img src="product.jpg" alt="Product name - detailed description">',
      impact:'Blind and low-vision users cannot understand image content.' });
    score -= 15;
  }

  if (html.includes('color: #aaa') || html.includes('color:#aaa') || html.includes('color:#bbb')) {
    issues.push({ id:'i2', severity:'critical', title:'Insufficient color contrast ratio', wcag:'1.4.3',
      description:'Light gray text (#aaa) on white background has a contrast ratio of ~2.3:1, far below the required 4.5:1 for normal text.',
      elementBefore:'<div style="color: #aaa; background: #fff;">Special Offer!</div>',
      elementAfter:'<div style="color: #595959; background: #fff;">Special Offer!</div>',
      impact:'Users with low vision or color blindness cannot read the text.' });
    score -= 15;
  }

  if (html.match(/onclick.*?(?!button|a\b)/i) && !html.includes('<button')) {
    issues.push({ id:'i3', severity:'critical', title:'Non-semantic clickable elements', wcag:'4.1.2',
      description:'Using onclick on <div> elements creates keyboard and screen reader barriers. Use semantic <button> or <a> elements instead.',
      elementBefore:'<div onclick="addToCart()">Add to Cart</div>',
      elementAfter:'<button type="button" onclick="addToCart()">Add to Cart</button>',
      impact:'Keyboard-only users and screen reader users cannot interact with these elements.' });
    score -= 20;
  }

  if (!html.includes('<label')) {
    issues.push({ id:'i4', severity:'critical', title:'Form inputs missing labels', wcag:'1.3.1',
      description:'Form inputs without associated <label> elements are not identifiable by screen readers. Placeholder text is not a substitute.',
      elementBefore:'<input type="text" placeholder="Enter email">',
      elementAfter:'<label for="email">Email Address</label>\n<input type="text" id="email" placeholder="Enter email">',
      impact:'Screen reader users hear only "edit text" with no context about what to enter.' });
    score -= 20;
  }

  if (html.includes('<marquee')) {
    issues.push({ id:'i5', severity:'warning', title:'Deprecated <marquee> element', wcag:'2.2.2',
      description:'The <marquee> element is deprecated and causes issues for users with cognitive disabilities and vestibular disorders.',
      elementBefore:'<marquee>Free shipping on orders over $50!</marquee>',
      elementAfter:'<p role="status" aria-live="polite">Free shipping on orders over $50!</p>',
      impact:'Moving content can trigger seizures and distract users with attention disorders.' });
    score -= 8;
  }

  if (html.includes('autoplay')) {
    issues.push({ id:'i6', severity:'warning', title:'Media autoplays without user consent', wcag:'1.4.2',
      description:'Autoplaying media can interfere with screen readers and distress users with vestibular disorders or sensory sensitivities.',
      elementBefore:'<video src="promo.mp4" autoplay>',
      elementAfter:'<video src="promo.mp4" controls>\n  <track kind="captions" src="captions.vtt" label="English">\n</video>',
      impact:'Screen reader audio gets drowned out; vestibular disorder users are harmed by sudden motion.' });
    score -= 8;
  }

  if (!html.includes('lang=')) {
    issues.push({ id:'i7', severity:'warning', title:'Missing language declaration', wcag:'3.1.1',
      description:'The <html> element must have a lang attribute so screen readers use correct pronunciation and language rules.',
      elementBefore:'<html>',
      elementAfter:'<html lang="en">',
      impact:'Screen readers may mispronounce content, making it incomprehensible.' });
    score -= 5;
  }

  if (html.includes('>Click here<') || html.includes('>click here<')) {
    issues.push({ id:'i8', severity:'warning', title:'Non-descriptive link text', wcag:'2.4.6',
      description:'"Click here" links provide no context when read out of context by screen readers navigating via links list.',
      elementBefore:'<a href="#">Click here</a>',
      elementAfter:'<a href="/deals">View current deals and offers</a>',
      impact:'Screen reader users navigating by links hear a list of "click here" with no meaning.' });
    score -= 5;
  }

  if (html.includes('tabindex="3"') || html.includes('tabindex="2"')) {
    issues.push({ id:'i9', severity:'info', title:'Positive tabindex disrupts natural focus order', wcag:'2.4.3',
      description:'Positive tabindex values override natural DOM tab order, causing confusing keyboard navigation patterns.',
      elementBefore:'<div tabindex="3">Skip to content</div>',
      elementAfter:'<a href="#main-content" class="skip-link" tabindex="0">Skip to main content</a>',
      impact:'Keyboard users experience unexpected and confusing focus jumps.' });
    score -= 4;
  }

  if (!html.includes('role="main"') && !html.includes('<main')) {
    issues.push({ id:'i10', severity:'info', title:'Missing landmark regions', wcag:'1.3.6',
      description:'Pages should use semantic landmarks (<main>, <nav>, <header>, <footer>) so screen reader users can quickly jump between sections.',
      elementBefore:'<div>...page content...</div>',
      elementAfter:'<main id="main-content" role="main">...page content...</main>',
      impact:'Screen reader users cannot efficiently navigate to main content areas.' });
    score -= 5;
  }

  return {
    score: Math.max(0, score),
    scoreDesc: score >= 80 ? 'Good accessibility with minor issues' : score >= 60 ? 'Moderate issues affecting key user groups' : 'Serious barriers present for many users',
    categories: {
      aria: Math.max(10, score + Math.floor(Math.random()*15) - 5),
      contrast: html.includes('#aaa') ? 20 : 85,
      screenReader: Math.max(10, score - 10),
      keyboard: html.includes('<button') ? 75 : 35
    },
    issues,
    fixedHTML: html
      .replace(/<html>/i, '<html lang="en">')
      .replace(/<img src="([^"]+)">/g, '<img src="$1" alt="Descriptive text for image">')
      .replace(/color: #aaa/g, 'color: #595959')
      .replace(/<div onclick="([^"]+)">([^<]+)<\/div>/g, '<button type="button" onclick="$1">$2</button>')
      .replace(/<marquee>([^<]+)<\/marquee>/g, '<p role="status">$1</p>')
      .replace(/autoplay/g, 'controls')
  };
}

function renderReport(result) {
  document.getElementById('reportContainer').style.display = 'flex';

  // Score
  const score = result.score;
  const circle = document.getElementById('scoreCircle');
  circle.textContent = score;
  const color = score >= 80 ? '#7fff6e' : score >= 60 ? '#ffdc6e' : '#ff6e7f';
  circle.style.background = `conic-gradient(${color} ${score * 3.6}deg, #1a1a24 0deg)`;
  circle.style.color = color;
  circle.style.boxShadow = `0 0 0 3px var(--surface), 0 0 0 4px ${color}33`;
  document.getElementById('scoreDesc').textContent = result.scoreDesc;

  // Category breakdown
  const cats = result.categories;
  const catLabels = { aria: 'ARIA', contrast: 'Contrast', screenReader: 'Screen Reader', keyboard: 'Keyboard' };
  const catColors = { aria: '#6eb8ff', contrast: '#ffdc6e', screenReader: '#7fff6e', keyboard: '#ff9d6e' };
  document.getElementById('scoreBreakdown').innerHTML = Object.entries(cats).map(([k, v]) =>
    `<div class="score-mini">
      <div class="score-mini-val" style="color:${catColors[k]}">${v}</div>
      <div style="font-size:0.65rem;color:var(--text-dim)">${catLabels[k]}</div>
    </div>`
  ).join('');

  // Filters
  const severities = ['all', 'critical', 'warning', 'info'];
  const counts = {};
  severities.forEach(s => counts[s] = s === 'all' ? result.issues.length : result.issues.filter(i => i.severity === s).length);
  document.getElementById('filterRow').innerHTML = severities.map(s =>
    `<button class="filter-btn f-${s} ${s === 'all' ? 'active' : ''}" onclick="setFilter('${s}')">${s === 'all' ? 'All' : s.charAt(0).toUpperCase()+s.slice(1)} (${counts[s]})</button>`
  ).join('');

  renderIssues(result.issues);
}

function renderIssues(issues) {
  const filtered = activeFilter === 'all' ? issues : issues.filter(i => i.severity === activeFilter);
  document.getElementById('issuesList').innerHTML = filtered.map(issue => `
    <div class="issue-card" id="card-${issue.id}" onclick="toggleCard('${issue.id}')">
      <div class="issue-header">
        <span class="severity-badge sev-${issue.severity}">${issue.severity}</span>
        <span class="issue-title">${issue.title}</span>
        <span class="issue-wcag">WCAG ${issue.wcag}</span>
        <span style="color:var(--text-dim);font-size:0.8rem;transition:transform 0.2s" id="arrow-${issue.id}">▾</span>
      </div>
      <div class="issue-body" id="body-${issue.id}">
        <div style="color:var(--text-dim)">${issue.description}</div>
        <div>
          <div class="code-label">Before (problematic)</div>
          <div class="code-block"><span class="bad">${escHtml(issue.elementBefore)}</span></div>
        </div>
        <div>
          <div class="code-label">After (fixed)</div>
          <div class="code-block" style="position:relative">
            <span class="good">${escHtml(issue.elementAfter)}</span>
            <button class="copy-btn" onclick="event.stopPropagation();copyCode('${btoa(issue.elementAfter)}')">Copy</button>
          </div>
        </div>
        <div style="background:var(--surface2);border-radius:3px;padding:0.6rem 0.75rem;font-size:0.72rem;color:var(--text-dim)">
          <span style="color:var(--accent2)">↳ Impact: </span>${issue.impact}
        </div>
      </div>
    </div>
  `).join('');
}

function setFilter(f) {
  activeFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.f-${f}`).classList.add('active');
  if (lastAnalysis) renderIssues(lastAnalysis.issues);
}

function toggleCard(id) {
  const card = document.getElementById('card-' + id);
  const arrow = document.getElementById('arrow-' + id);
  card.classList.toggle('expanded');
  arrow.style.transform = card.classList.contains('expanded') ? 'rotate(180deg)' : '';
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function copyCode(b64) {
  navigator.clipboard.writeText(atob(b64)).catch(() => {});
}

function copyFixed() {
  if (lastAnalysis && lastAnalysis.fixedHTML) {
    navigator.clipboard.writeText(lastAnalysis.fixedHTML).then(() => {
      const btn = event.target;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy Fixed HTML', 1500);
    });
  }
}

function exportReport() {
  if (!lastAnalysis) return;
  const txt = `ACCESSIBILITY REPORT
Generated by AccessAI — ${new Date().toLocaleString()}

SCORE: ${lastAnalysis.score}/100
${lastAnalysis.scoreDesc}

CATEGORY SCORES:
${Object.entries(lastAnalysis.categories).map(([k,v]) => `  ${k}: ${v}/100`).join('\n')}

ISSUES (${lastAnalysis.issues.length} found):
${lastAnalysis.issues.map((i,n) => `
${n+1}. [${i.severity.toUpperCase()}] ${i.title}
   WCAG: ${i.wcag}
   ${i.description}
   Before: ${i.elementBefore}
   After: ${i.elementAfter}
   Impact: ${i.impact}
`).join('')}`;

  const blob = new Blob([txt], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'accessibility-report.txt';
  a.click();
}
</script>

</body>
</html>